# 🤖 로봇/PLC 핸드셰이크 프로토콜 (FSM 지침)

본 문서는 Vision-PLC-로봇 연동 시 안전한 명령 발행을 위한 FSM(상태머신) 동작 규약을 정리한 것이다.  
이 규약을 따르면 신호가 붙잡히거나 클리어되지 않아도 **큐 폭주 없이, 매 사이클 확실하게 동작**한다.

---

## 1. FSM 동작 흐름

1. **초기 대기**
   - 조건: `READY=1`, `BUSY=0`, `DONE=0`, 컨트롤러 `PUBLISH_REQ=0`
   - 의미: 로봇 Idle, 명령 수신 준비 상태

2. **Publish 시작**
   - 컨트롤러: 타겟 좌표를 Holding Register(132..143)에 기록
   - 컨트롤러: `PUBLISH_REQ=1` 올림

3. **로봇 동작 개시**
   - 로봇: `PUBLISH_REQ=1` 감지 후 좌표 래치
   - 로봇: `BUSY=1` ↑ (실행 시작 알림)

4. **로봇 완료 알림**
   - 로봇: 작업 완료 시 `BUSY=0` ↓, 동시에 `DONE=1` ↑
   - 컨트롤러: BUSY↓ & DONE=1 조건 확인
   - 컨트롤러: `PUBLISH_REQ=0` 내림 (ACK)

5. **로봇 완료 신호 클리어**
   - 로봇: `PUBLISH_REQ=0` 확인 후 `DONE=0` ↓ 클리어
   - 컨트롤러: DONE↓ 감지 → `WaitRobotReady` 상태 복귀

6. **다음 사이클 준비**
   - 조건: `READY=1 & BUSY=0`
   - FSM: 다음 포즈 Publish
   - READY=1이 계속 유지돼도 DONE↓ → WaitRobotReady → READY=1 조건으로 안전하게 재시작

---

## 2. 로봇/PLC 신호 요약 (권장)

| 단계         | READY | BUSY | DONE | PUBLISH_REQ | 설명                   |
|--------------|-------|------|------|-------------|------------------------|
| Idle 대기    | 1     | 0    | 0    | 0           | 로봇 Idle, 대기 상태   |
| 컨트롤러 전송 | 1     | 0    | 0    | 1           | 좌표 Write + Req=1     |
| 로봇 시작    | 1/0   | 1    | 0    | 1           | 로봇 작업 시작          |
| 로봇 완료    | 1/0   | 0    | 1    | 1           | 작업 완료, Done=1      |
| 컨트롤러 ACK | 1/0   | 0    | 1    | 0           | 컨트롤러 Ack            |
| 로봇 클리어  | 1     | 0    | 0    | 0           | Done=0 내려 클리어     |

---

## 3. READY 신호 의미

- READY는 **로봇 프로그램 실행 + 통신 연결 정상**을 나타내는 **레벨 신호(Idle=1)**  
- **토글 신호 아님**  
- FSM은 DONE↓ 이후 WaitRobotReady로 복귀 → READY=1 조건 확인 후 다시 발행  
- 따라서 로봇이 READY를 Low/High로 토글할 필요는 없음

---
